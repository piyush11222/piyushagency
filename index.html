<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Piyush Agency — Admin</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;margin:0;padding:0}
    .container{max-width:820px;margin:18px auto;padding:12px}
    .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.06);margin-bottom:14px}
    input,textarea,button{width:100%;padding:10px;margin-top:8px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box}
    button{background:#1e88e5;border:none;color:#fff;font-weight:600;padding:10px}
    .danger{background:#e53935}
    .muted{font-size:13px;color:#666;margin-top:8px}
    .flex{display:flex;gap:8px}
    .flex> *{flex:1}
    img.logo-preview{max-width:160px;max-height:160px;border-radius:8px;display:block;margin-top:8px}
    label.small{font-size:13px;color:#444;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <h2>Admin Login</h2>
      <label>Email</label>
      <input id="email" placeholder="your-admin@example.com" />
      <label>Password</label>
      <input id="password" type="password" placeholder="Your password" />
      <button id="btnLogin">Login</button>
      <div id="loginMsg" class="muted"></div>
      <div class="muted">Only the admin can log in. No public signups.</div>
    </div>

    <!-- DASHBOARD -->
    <div class="card" id="dashboard" style="display:none">
      <h2>Admin Dashboard</h2>

      <label>Site Title</label>
      <input id="siteTitle" />

      <label>About / Hero text</label>
      <textarea id="aboutText" rows="4"></textarea>

      <label>Contact Number or Info</label>
      <input id="contact" />

      <hr style="margin-top:12px;margin-bottom:12px"/>

      <label class="small">Logo (upload from your phone) — this overwrites previous logo</label>
      <input id="logoFile" type="file" accept="image/*" />
      <button id="btnUploadLogo" style="margin-top:8px">Upload Logo</button>
      <div id="logoMsg" class="muted"></div>
      <img id="logoPreview" class="logo-preview" src="" alt="" style="display:none"/>

      <div class="flex" style="margin-top:12px">
        <button id="btnSave">Save Changes</button>
        <button id="btnLogout" class="danger">Logout</button>
      </div>
      <div id="saveMsg" class="muted"></div>
    </div>

    <!-- PUBLIC PREVIEW -->
    <div class="card">
      <div style="display:flex; align-items:center; gap:12px;">
        <img id="publicLogo" src="" alt="logo" style="max-width:84px;max-height:84px;border-radius:8px;display:none" />
        <div>
          <div id="publicTitle" style="font-weight:700; font-size:18px">Piyush Agency</div>
          <div id="publicAbout" style="margin-top:6px">Welcome to Piyush Agency.</div>
          <div id="publicContact" class="muted" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
  // ==== FIREBASE CONFIG (your config already provided) ====
  const firebaseConfig = {
    apiKey: "AIzaSyAUoKa_d6aeheuKRTyRm_7cla1aJEbUUoQ",
    authDomain: "piyush-agency.firebaseapp.com",
    projectId: "piyush-agency",
    storageBucket: "piyush-agency.firebasestorage.app",
    messagingSenderId: "931552293046",
    appId: "1:931552293046:web:94c6d622e3a9edad587617",
    measurementId: "G-V2L4CVKDPZ"
  };
  // ======================================================

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // UI elements
  const loginCard = document.getElementById('loginCard');
  const dashboard = document.getElementById('dashboard');
  const loginMsg = document.getElementById('loginMsg');
  const saveMsg = document.getElementById('saveMsg');
  const logoMsg = document.getElementById('logoMsg');
  const logoPreview = document.getElementById('logoPreview');
  const publicLogo = document.getElementById('publicLogo');

  // Login
  document.getElementById('btnLogin').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) { loginMsg.textContent = "Enter email and password."; return; }
    loginMsg.textContent = "Signing in...";
    try {
      await auth.signInWithEmailAndPassword(email, password);
      loginMsg.textContent = "Signed in.";
    } catch (err) {
      console.error(err);
      loginMsg.textContent = "Login failed: " + err.message;
    }
  };

  // Logout
  document.getElementById('btnLogout').onclick = () => auth.signOut();

  // Save text content
  document.getElementById('btnSave').onclick = async () => {
    saveMsg.textContent = "Saving...";
    const title = document.getElementById('siteTitle').value;
    const about = document.getElementById('aboutText').value;
    const contact = document.getElementById('contact').value;
    try {
      await db.collection('siteContent').doc('main').set({
        title, about, contact,
        // if you want logoUrl preserved when not uploading, ensure you merge or read previous value first.
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      saveMsg.textContent = "Saved ✓";
    } catch (e) {
      console.error(e);
      saveMsg.textContent = "Save failed: " + e.message;
    }
  };

  // Upload Logo (single overwrite)
  document.getElementById('btnUploadLogo').onclick = async () => {
    const fileInput = document.getElementById('logoFile');
    const file = fileInput.files && fileInput.files[0];
    if (!file) { logoMsg.textContent = "Choose an image first."; return; }
    logoMsg.textContent = "Uploading...";
    try {
      // Use fixed path so each upload overwrites previous
      const path = 'siteAssets/logo.png';
      const ref = storage.ref().child(path);
      // Optionally resize client-side or validate size/type here
      await ref.put(file);
      const url = await ref.getDownloadURL();
      // save url in firestore so public preview reads it
      await db.collection('siteContent').doc('main').set({
        logoUrl: url,
        logoUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      logoMsg.textContent = "Logo uploaded ✓";
      logoPreview.src = url; logoPreview.style.display = 'block';
    } catch (e) {
      console.error(e);
      logoMsg.textContent = "Upload failed: " + e.message;
    }
  };

  // Auth state
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      loginCard.style.display = 'none';
      dashboard.style.display = 'block';
      // load content including logo
      try {
        const snap = await db.collection('siteContent').doc('main').get();
        const data = snap.exists ? snap.data() : {};
        document.getElementById('siteTitle').value = data.title || '';
        document.getElementById('aboutText').value = data.about || '';
        document.getElementById('contact').value = data.contact || '';
        if (data.logoUrl) {
          logoPreview.src = data.logoUrl; logoPreview.style.display = 'block';
        } else { logoPreview.style.display = 'none'; }
      } catch (e) {
        console.error(e);
      }
    } else {
      loginCard.style.display = 'block';
      dashboard.style.display = 'none';
    }
  });

  // Realtime public preview (any visitor sees updates)
  db.collection('siteContent').doc('main').onSnapshot(doc => {
    const d = doc.exists ? doc.data() : {};
    document.getElementById('publicTitle').textContent = d.title || 'Piyush Agency';
    document.getElementById('publicAbout').textContent = d.about || 'Welcome to Piyush Agency.';
    document.getElementById('publicContact').textContent = d.contact ? 'Contact: ' + d.contact : '';
    if (d.logoUrl) {
      publicLogo.src = d.logoUrl;
      publicLogo.style.display = 'block';
    } else {
      publicLogo.style.display = 'none';
    }
  }, err => {
    console.error('snapshot error', err);
  });
  </script>
</body>
</html>
